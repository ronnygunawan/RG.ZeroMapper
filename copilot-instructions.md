# Copilot Instructions for RG.ZeroMapper

This document provides guidance for maintaining the RG.ZeroMapper repository, including conventions, architecture decisions, and important considerations.

## Repository Structure

- **src/RG.ZeroMapper**: Core mapper library with source generator for automatic type mapping
- **src/RG.ZeroMapper.Structural**: Source generator for structural typing (Intersect, Union, OneOf)
- **src/RG.ZeroMapper.Structural.Abstractions**: Base types for structural typing (Constant, Intersect, Union, OneOf)
- **samples/**: Example projects demonstrating usage
- **tests/**: Unit test projects

## Architecture Decisions

### Structural Typing Base Types

**Important:** The base types (`Constant`, `Intersect<>`, `Union<>`, `OneOf<>`) are defined in the **RG.ZeroMapper.Structural.Abstractions** project, NOT generated by the source generator.

**Rationale:** 
- When multiple projects reference `RG.ZeroMapper.Structural` and use the same structural types (e.g., `OneOf<T1, T2>`), having each project generate its own copy of the base types causes **CS0436 compiler warnings** about conflicting types.
- By shipping the base types as a separate runtime library (`RG.ZeroMapper.Structural.Abstractions`), all projects reference the same shared base types, eliminating conflicts.

**What this means for maintenance:**

1. **DO NOT** re-introduce code generation of base types in `StructuralTypingGenerator.cs`
2. **DO** keep the `GenerateSupportTypes()` method as a no-op for backward compatibility
3. **DO** ensure `RG.ZeroMapper.Structural.csproj` has a project reference to `RG.ZeroMapper.Structural.Abstractions` with `PrivateAssets="none"` so it flows as a dependency to consumers
4. **DO** maintain all 16 arities (from 1 to 16 type parameters) for each base type in the Abstractions project

### Adding New Structural Types

If you need to add new structural types (beyond Constant, Intersect, Union, OneOf):

1. **Add the base type** to `RG.ZeroMapper.Structural.Abstractions` with all necessary arities (typically 1-16)
2. **Update the generator** in `StructuralTypingGenerator.cs` to detect and generate implementations for the new type
3. **Add tests** in `RG.ZeroMapper.Structural.Tests`
4. **Update README** with examples

### Source Generator Best Practices

- Use `IncrementalGenerator` interface for better performance
- Generate code that is compatible with netstandard2.0
- Include `// <auto-generated/>` comment at the top of generated files
- Use `#nullable enable` in generated code for consistency
- Add XML documentation comments to generated members

## Build and Test

### Building the Project

```bash
dotnet build
```

The build process:
1. Builds `RG.ZeroMapper.Structural.Abstractions` (runtime library)
2. Builds `RG.ZeroMapper.Structural` (source generator + references Abstractions)
3. Builds `RG.ZeroMapper` (separate mapper library)
4. Builds samples and tests

### Running Tests

```bash
dotnet test
```

All tests must pass before merging changes.

### Running Samples

```bash
cd samples/StructuralSample
dotnet run

cd ../BasicSample
dotnet run
```

## Package Publishing

Both `RG.ZeroMapper.Structural` and `RG.ZeroMapper.Structural.Abstractions` are published as separate NuGet packages:

- **RG.ZeroMapper.Structural.Abstractions**: Runtime library with base types
  - Version should be kept in sync with the source generator
  - Target framework: netstandard2.0
  
- **RG.ZeroMapper.Structural**: Source generator
  - Depends on `RG.ZeroMapper.Structural.Abstractions`
  - Packaged as an analyzer in `analyzers/dotnet/cs`

## Preventing CS0436 Warning from Resurfacing

### What Causes CS0436

The **CS0436 warning** occurs when:
1. Project A references `RG.ZeroMapper.Structural` and generates types like `OneOf<T1, T2>`
2. Project B also references `RG.ZeroMapper.Structural` and generates the same types
3. Project C references both A and B, causing a conflict

### How We Prevent It

By moving base types to `RG.ZeroMapper.Structural.Abstractions`:
- All projects reference the **same shared DLL** containing the base types
- No more duplicate type definitions
- No more CS0436 warnings

### What NOT to Do

❌ **DO NOT** change `GenerateSupportTypes()` to generate base types again
❌ **DO NOT** mark base types as `internal` in the Abstractions project (they must be `public`)
❌ **DO NOT** remove the dependency from `RG.ZeroMapper.Structural` to `RG.ZeroMapper.Structural.Abstractions`

### If You See CS0436 Again

If CS0436 warnings resurface:

1. **Check** that `GenerateSupportTypes()` is not generating base types
2. **Verify** that `RG.ZeroMapper.Structural.csproj` has the correct reference:
   ```xml
   <ProjectReference Include="..\RG.ZeroMapper.Structural.Abstractions\RG.ZeroMapper.Structural.Abstractions.csproj" PrivateAssets="none" />
   ```
3. **Ensure** consuming projects reference both the generator and abstractions (this should happen automatically via transitive dependencies)

## Code Style

- Use C# latest language version
- Enable nullable reference types
- Follow existing naming conventions
- Add XML documentation for public APIs
- Keep generated code minimal and efficient

## Common Issues

### Issue: Tests fail after modifying generator

**Solution:** Clean and rebuild
```bash
dotnet clean
dotnet build
dotnet test
```

### Issue: Generator not producing output

**Solution:** Check that:
1. Class is marked as `partial`
2. Class inherits from one of the base types (Intersect, Union, OneOf)
3. Project references both the generator and abstractions packages

### Issue: CS0436 warnings about conflicting types

**Solution:** Verify the architecture is maintained as described in "Structural Typing Base Types" above.

## Contact

For questions about this repository, please open an issue on GitHub.
